const M={compactWidth:!1,v4Notice:!1},m=Object.assign({},M);function re(e){var o;m.v4Notice=!0;const t=["compactWidth","windowAction","selectAfterImport","customizeDrop","dropToFrame"];for(const n of t){const i=(o=e.options)==null?void 0:o[n];i!==void 0&&(m[n]=i)}return m}async function se(){try{const e=await figma.clientStorage.getAsync("config");switch(e==null?void 0:e.version){case 2:re(e);break;case 3:Object.assign(m,e);break}}catch(e){}return m}function ae(){const e={version:3};let t;for(t in M){const o=m[t],n=M[t];n!==void 0&&n!==o&&(e[t]=o)}figma.clientStorage.setAsync("config",e).catch()}function le(){const e=figma;try{const t=e.editorType;switch(t){case"figma":case"figjam":return t}}catch(t){console.error(t)}try{if(typeof e.createSticky=="function")return"figjam"}catch(t){console.error(t)}return"figma"}const p={app:le(),loaded:!1,minimized:!1,config:m};function R(){const e=p.app;return e==="figjam"?"FigJam":e.slice(0,1).toUpperCase()+e.slice(1)}const E={mini:{width:200,height:104},full:{width:480,min:580,max:720},compact:{width:352,min:520,max:640},innerDiff:90,outerDiff:150};function x(){const e=p.config.compactWidth,t=E[e?"compact":"full"];let o;if(p.windowInnerHeight){const n=p.windowOuterHeight?p.windowOuterHeight-E.outerDiff:p.windowInnerHeight-E.innerDiff;o=Math.max(Math.min(n,t.max),t.min)}else o=t.max;return{width:t.width,height:o}}function y(e){figma.ui.postMessage(e)}function fe(e){switch(e.type){case"PAGE":case"COMPONENT":case"FRAME":case"SECTION":case"GROUP":return e}}function ue(e){switch(e.type){case"FRAME":case"COMPONENT":return e}}function W(e){return{type:"icon-set",prefix:e,parent:{type:"icon-sets"}}}function ge(e){function t(){if(e.getSharedPluginData("iconify","source")==="iconify"){const n=JSON.parse(e.getSharedPluginData("iconify","props")),c=n.name.split(":");if(c.length===2)switch(n.version){case 3:{const r=n.route||W(c[0]);return Object.assign(n,{route:r})}default:{const r=n.props;let s;return typeof n.color=="string"?s=n.color:typeof r=="object"&&(s=r.color),{version:3,name:n.name,props:{color:s},route:W(c)}}}}}try{return t()}catch(o){}}function $(e){return{nodes:e.nodes||Object.create(null),ignoreIconNode:e.ignoreIconNode||!1,iconNodeID:e.iconNodeID||null,iconNodeData:e.iconNodeData||null}}function T(e,t,o){function n(i,c,r){const s=i.id,l=t.nodes[s];if(l)return r&&l.children.push(r),l;let a="invalid",h=!1,g,f;const u=ue(i);u&&(g=ge(u),g&&(f=u.height,t.iconNodeID?t.ignoreIconNode=!0:(t.iconNodeID=s,t.iconNodeData=g)));const d=fe(i);d?d.type==="PAGE"?(a="valid",h=!0):(d.locked||(a="valid"),(!c||d.locked)&&(t.ignoreIconNode=!0),h=d.type!=="FRAME"):i.type==="COMPONENT_SET"?a="ignored":t.ignoreIconNode=!0;const w={type:i.type,id:s,name:i.name,target:a,children:r?[r]:[],primary:c,relative:h,icon:g,height:f};return t.nodes[s]=w,i.parent&&i.type!=="PAGE"&&n(i.parent,c,i.id),w}return n(e,o)}const de=16;function J(){const e=figma.currentPage,t=e.selection,o=$({}),n=T(e,o,!1);t.forEach((d,w)=>{T(d,o,!w)});const{nodes:i,iconNodeData:c,iconNodeID:r,ignoreIconNode:s}=o,l=[];let a=n.id,h;function g(d,w=0){switch(d.target){case"ignored":{d.children.forEach(I=>{g(i[I],w)});break}case"valid":switch(d.type){case"PAGE":case"COMPONENT":case"FRAME":case"SECTION":case"GROUP":const I={id:d.id,name:d.name,depth:w,type:d.type};!s&&c&&r===d.id&&(I.icon=c,I.height=d.height,h=I),d.icon||(l.push(I),d.primary&&!d.icon&&(a=d.id),d.children.forEach(ce=>{g(i[ce],w+1)}))}}}g(n);let f=!1,u=de;for(;l.length>u;)l.pop()===h&&(f=!0,u--);return f&&h&&l.push(h),{nodes:l,defaultNode:a,iconNode:h}}let L=J();function _(){return L}function he(e){L=e}const D="style:";function Y(e){function t(o){const n=Math.round(o*255).toString(16);return n.length<2?"0"+n:n}return"#"+t(e.r)+t(e.g)+t(e.b)}function F(e){const t=e.paints[0].color;return{id:e.id,name:e.name,color:Y(t),remote:e.remote}}function H(e){return e.type==="SOLID"&&e.visible!==!1&&e.blendMode==="NORMAL"&&e.opacity===1?e:void 0}function k(e){if(e.paints.length===1)return H(e.paints[0])}function X(e){const t=figma.getStyleById(e);if((t==null?void 0:t.type)==="PAINT"&&k(t))return t.id}const v=new Set;async function pe(){const e=[];return(await figma.getLocalPaintStylesAsync()).forEach(t=>{try{v.add(t.id),k(t)&&e.push(F(t))}catch(o){console.log("Error parsing color style:",o)}}),e}function q(){const e=figma.getSelectionColors(),t=[];return e==null||e.styles.forEach(o=>{const n=o.id;v.has(n)||(v.add(n),k(o)&&t.push(F(o)))}),t.length?t:void 0}function me(e){async function t(o){const n=[];for(const i of o)if(i.startsWith(D)){const c=i.slice(D.length);if(!v.has(c)){v.add(c);const r=await figma.getStyleByIdAsync(c);(r==null?void 0:r.type)==="PAINT"&&k(r)&&n.push(F(r))}}n.length&&y({type:"plugin:color-styles",styles:n})}e&&setTimeout(()=>{t(e).catch(console.error)})}let b=!1;function ye(){const e=J();if(JSON.stringify(e)!==JSON.stringify(_())){he(e);const t=q();y({type:"plugin:nodes",nodes:e,styles:t})}}function O(){b||(b=!0,setTimeout(()=>{b=!1,ye()},250))}async function S(e,t=void 0,o){try{const n=await figma.clientStorage.getAsync(e);if(n)return o?o(n):n}catch(n){}return t}function P(e,t){figma.clientStorage.setAsync(e,t).catch()}const Q="recent";let N=[];const Ne=64;async function we(){const e=await S(Q);return e&&(N=e),e}let C=!1;function Z(){C||(C=!0,setTimeout(()=>{C=!1,P(Q,N),y({type:"plugin:recent-icons",icons:N})},1e3))}function ee(e){for(const t of e){const o=N.indexOf(t);o!==-1&&N.splice(o,1),N.unshift(t),N.length>Ne&&N.pop(),Z()}}function Ie(){N=[],Z()}async function te(e,t){function o(c){try{if(c.length===1){const r=c[0];if(H(c[0]))return!0}}catch(r){}}async function n(c){o(c.fills)&&(typeof t=="string"?await c.setFillStyleIdAsync(t):c.fills=[t]),o(c.strokes)&&(typeof t=="string"?await c.setStrokeStyleIdAsync(t):c.strokes=[t])}async function i(c){const r=c;if(r.locked||r.isMask)return;try{await n(r)}catch(l){}const s=c.children;if(s)for(const l of s)await i(l)}for(const c of e.children)await i(c)}const Se={replace:"Replace icon",code:"Icon code"};function ne(e,t,o,n){e.name=t,e.setSharedPluginData("iconify","source","iconify");const i={version:3,name:t,props:o,route:n};e.setSharedPluginData("iconify","props",JSON.stringify(i)),e.setRelaunchData(Se)}function oe(e,t){const o=figma.createNodeFromSvg(e);let n;if(t.replace?n=t.replace:t.component&&(n=figma.createComponent()),n){for(;n.children.length>0;)n.children[0].remove();n.resizeWithoutConstraints(o.width,o.height);for(const c of o.children)n.appendChild(c);if(o.remove(),t.replace)return n}const i=n||o;if(t.parent){const c=t.parent;let r=!0;const s=c.layoutMode;s&&s!=="NONE"&&(r=!1),r?c.appendChild(i):c.insertChild(0,i),t.x&&(i.x=t.x),t.y&&(i.y=t.y)}return i.constrainProportions=!0,i}function z(e,t,o,n){if(e.type==="PAGE")return t;let i=0,c=n?e.width:e.height;if(e.type==="GROUP"&&(i=n?e.x:e.y),t<i)return i;const r=i+c-o;return t>r?Math.max(i,r):t}function ie(e,t,o){const n=t.icons.reduce((s,l)=>s+Math.ceil(l.width),0);let i=z(e,Math.round(o.targetX-n/2),n,!0),c;t.props.style&&(c=X(t.props.style));const r=[];for(const s of t.icons){const l=z(e,Math.round(o.targetY-s.height/2),s.height,!1),a=oe(s.content,{parent:e,x:i,y:l,component:o.component});ne(a,s.name,t.props,t.route),i+=Math.ceil(s.width),r.push(a),s.monotone&&c&&te(a,c).catch(console.error)}return ee(t.icons.map(s=>s.name)),y({type:"plugin:notice",color:"success",text:`Imported ${t.icons.length>1?t.icons.length+" icons":t.icons[0].name} to ${R()}`}),figma.currentPage.selection=r,O(),r}function G(){y({type:"plugin:notice",color:"error",text:"Error dropping icon(s) to "+R()})}function Pe(e){try{if(e.dropMetadata.source!=="iconify")return!0}catch(f){return!0}let t=e.x,o=e.y;const n=e.node;n.type==="GROUP"&&(t+=n.x,o+=n.y);const i=$({});T(n,i,!0);const c=i.nodes[figma.currentPage.id];if(!c)return console.error("Cannot find current page item in scanned nodes list"),G(),!0;let r=0,s=0,l=!0,a=c,h=c;for(;a.children.length;){const f=a.children[0];if(a=i.nodes[f],a.icon||a.target==="invalid"?l=!1:l&&a.target==="valid"&&(h=a),!l&&a.relative){const u=figma.getNodeById(a.id);u&&(r+=u.x||0,s+=u.y||0)}}const g=figma.getNodeById(h.id);return g?(ie(g,e.dropMetadata,{targetX:r+t,targetY:s+o}),!1):(console.error("Failed to get target node"),G(),!0)}function A(){y({type:"plugin:notice",color:"error",text:"Error importing icon(s) to "+R()})}function ve(e,t){const o=figma.getNodeById(e);if(!o){A();return}const n=o.name;let i,c;const r=figma.currentPage.selection;if(r.length===1&&r[0].id===o.id){const s=figma.getSelectionColors();if(s){const l=s.paints,a=s.styles;l.length+a.length===1?(a.length&&k(a[0])&&(i=a[0].id,c=D+i),l.length&&(i=H(l[0]),i&&(c=Y(i.color)))):t.props.style&&(i=X(t.props.style))}}for(const s of t.icons){const l=s.name,a=oe(s.content,{replace:o,x:o.x,y:o.y});ne(a,l,t.props,t.route),ee([l]),y({type:"plugin:notice",color:"success",text:`Replaced ${n} with ${l}`}),figma.currentPage.selection=[a],O(),s.monotone&&i&&te(a,i).catch(console.error),s.monotone&&c&&y({type:"plugin:recent-color",color:c});return}A()}function ke(e,t,o){const n=figma.getNodeById(e);if(!n){A();return}let i,c;switch(n.type){case"PAGE":{const r=figma.viewport.center;i=r.x,c=r.y;break}case"GROUP":{i=n.x+n.width/2,c=n.y+n.height/2;break}default:{i=n.width/2,c=n.height/2;break}}ie(n,t,{component:o,targetX:i,targetY:c})}const U="icon-sets",j="route-v3",K="icon-sets-filters",V="recent-colors",B="customisations";(async()=>{var h;console.log("Starting plugin..."),await se();const e=await S(U,void 0,g=>g.version===3?g.data:void 0);let t=await S(j);const o=await we(),n=await S(K),i=await S(V);let c=await S(B);const r=_(),s=q();let l;if(figma.command==="replace"){const g=(h=r.iconNode)==null?void 0:h.icon;if(g){l=g.name,g.route&&(t=g.route);const f=g.props;f&&(c={size:f.size,color:f.style?D+f.style:f.color})}}figma.on("selectionchange",O),figma.on("currentpagechange",O),figma.on("drop",Pe),figma.ui.onmessage=g=>{try{if(typeof g.type!="string")return}catch(u){console.error(u)}const f=g;switch(f.type){case"ui:fatal-error":{figma.closePlugin(f.error);break}case"ui:loaded":{if(f.innerHeight||f.outerHeight){p.windowInnerHeight=f.innerHeight,p.windowOuterHeight=f.outerHeight;const u=x();u.height!==p.lastWindowHeight&&(p.lastWindowHeight=u.height,figma.ui.resize(u.width,u.height))}y({type:"plugin:starting",app:p.app,command:figma.command,config:m,nodes:r,styles:s,lists:e,recent:o,route:t,filters:n,selectIcon:l,recentColors:i,custom:c}),pe().then(u=>{u.length&&y({type:"plugin:color-styles",styles:u})}).catch(console.error),me(i);break}case"ui:close":{figma.closePlugin();break}case"ui:compact":{m.compactWidth=!m.compactWidth;const u=x();u.height!==p.lastWindowHeight&&(p.lastWindowHeight=u.height,figma.ui.resize(u.width,u.height)),y({type:"plugin:resize",compactWidth:m.compactWidth,minimized:!1}),ae();break}case"ui:lists":{const u={version:3,data:f.lists};P(U,u);break}case"ui:route":{P(j,f.route);break}case"ui:filters":{P(K,f.filters);break}case"ui:replace-icon":{ve(f.node,f.data);break}case"ui:import-icons":{ke(f.node,f.data,f.component||!1);break}case"ui:recent-colors":{P(V,f.colors);break}case"ui:customisations":{P(B,f.custom);break}case"ui:reset-recent-icons":{Ie();break}}};const a=x();p.lastWindowHeight=a.height,figma.showUI(__html__,Object.assign({themeColors:!1},a))})();
